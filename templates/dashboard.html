{% extends "base.html" %}
{% block content %}

<!-- KPIs PRINCIPALES -->
<div class="row mb-4">
    <!-- PAGOS HOY -->
    <div class="col-md-3">
        <div class="card border-{% if total_pagos_hoy > 0 %}success{% else %}secondary{% endif %}">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Pagos hoy</h5>
                <h2 class="card-text {% if total_pagos_hoy > 0 %}text-success{% else %}text-secondary{% endif %}">
                    {{ total_pagos_hoy }}
                </h2>
                <small class="{% if diferencia_pagos > 0 %}text-success{% elif diferencia_pagos < 0 %}text-danger{% else %}text-muted{% endif %}">
                    {% if diferencia_pagos > 0 %}↗ +{{ diferencia_pagos }} vs ayer
                    {% elif diferencia_pagos < 0 %}↘ {{ diferencia_pagos }} vs ayer
                    {% else %}– igual que ayer{% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- INCIDENCIAS ABIERTAS -->
    <div class="col-md-3">
        <div class="card border-{% if incidencias_abiertas > 0 %}warning{% else %}success{% endif %}">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Incidencias abiertas</h5>
                <h2 class="card-text {% if incidencias_abiertas > 0 %}text-warning{% else %}text-success{% endif %}">
                    {{ incidencias_abiertas }}
                </h2>
                <small class="{% if diferencia_incidencias > 0 %}text-danger{% elif diferencia_incidencias < 0 %}text-success{% else %}text-muted{% endif %}">
                    {% if diferencia_incidencias > 0 %}↗ +{{ diferencia_incidencias }} vs ayer
                    {% elif diferencia_incidencias < 0 %}↘ {{ diferencia_incidencias }} vs ayer
                    {% else %}– igual que ayer{% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- FIRMAS PENDIENTES -->
    <div class="col-md-3">
        <div class="card border-{% if firmas_pendientes > 0 %}info{% else %}success{% endif %}">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Firmas pendientes</h5>
                <h2 class="card-text {% if firmas_pendientes > 0 %}text-info{% else %}text-success{% endif %}">
                    {{ firmas_pendientes }}
                </h2>
                <small class="{% if diferencia_firmas > 0 %}text-info{% elif diferencia_firmas < 0 %}text-success{% else %}text-muted{% endif %}">
                    {% if diferencia_firmas > 0 %}↗ +{{ diferencia_firmas }} vs ayer
                    {% elif diferencia_firmas < 0 %}↘ {{ diferencia_firmas }} vs ayer
                    {% else %}– igual que ayer{% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- ÚLTIMO ARQUEO -->
    <div class="col-md-3">
        <div class="card border-{% if estado_arqueo == 'OK' %}success{% elif estado_arqueo == 'CON DIFERENCIAS' %}warning{% else %}secondary{% endif %}">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Último arqueo</h5>
                <h2 class="card-text {% if estado_arqueo == 'OK' %}text-success{% elif estado_arqueo == 'CON DIFERENCIAS' %}text-warning{% else %}text-secondary{% endif %}">
                    {{ estado_arqueo }}
                </h2>
                <small class="text-muted">
                    {% if fecha_arqueo %}
                        {{ fecha_arqueo|date:"d/m/Y" }}
                    {% else %}
                        Sin datos
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- ALERTAS Y PENDIENTES -->
<div class="row g-3 mt-1">
  <!-- Alertas recientes -->
  <div class="col-lg-7">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Alertas recientes</h6>
        <a href="/conciliacion/" class="small text-decoration-none">Ir a Conciliación</a>
      </div>
      <hr class="my-2">
      <div class="list-group list-group-flush">
        {% for alerta in alertas_recientes %}
        <a class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <span class="badge 
              {% if alerta.tipo_incidencia == 'DIF_MONTO' %}text-bg-warning
              {% elif alerta.tipo_incidencia == 'SIN_MATCH' %}text-bg-danger
              {% else %}text-bg-info{% endif %} me-2">
              {{ alerta.tipo_incidencia }}
            </span>
            {{ alerta.descripcion }}
          </div>
          <small class="text-muted">{{ alerta.fecha_apertura|timesince }} ago</small>
        </a>
        {% empty %}
        <div class="list-group-item text-muted text-center">No hay alertas recientes</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Pendientes de firma -->
  <div class="col-lg-5">
    <div class="card p-3 h-100">
      <h6 class="mb-1">Pendientes de firma</h6>
      <hr class="my-2">
      <ul class="list-unstyled small mb-3">
        {% for pendiente in pendientes_firma %}
        <li class="d-flex justify-content-between">
          <span>{{ pendiente.numero_referencia }} · {{ pendiente.get_tipo_incidencia_display }}</span>
          <span class="badge text-bg-secondary">{{ pendiente.get_estado_display }}</span>
        </li>
        {% empty %}
        <li class="text-muted text-center">No hay pendientes de firma</li>
        {% endfor %}
      </ul>
      <div class="d-grid gap-2">
        <a class="btn btn-primary" href="/conciliacion/"><i class="bi bi-diagram-2 me-1"></i> Conciliar & Arqueo</a>
        <a class="btn btn-outline-primary" href="/bitacora/"><i class="bi bi-journal-text me-1"></i> Ver Bitácora</a>
      </div>
    </div>
  </div>
</div>

<!-- ESTADO DE CONCILIACIÓN DE HOY -->
<div class="card p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Conciliación de hoy</h6>
    <small class="text-muted">Corte 12:00</small>
  </div>
  <hr class="my-2">
  <div class="row g-3">
    <div class="col-md-4">
        <div class="small text-muted mb-1">Match Sistema vs Externo</div>
        <div class="progress" role="progressbar" aria-label="match">
            <div class="progress-bar bg-success" style="width: {{ match_sistema }}%">{{ match_sistema }}%</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="small text-muted mb-1">Diferencias (D2)</div>
        <div class="progress" role="progressbar" aria-label="diferencias">
            <div class="progress-bar bg-warning text-dark" style="width: {{ diferencias_conciliacion }}%">{{ diferencias_conciliacion }}%</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="small text-muted mb-1">Sin match</div>
        <div class="progress" role="progressbar" aria-label="sin-match">
            <div class="progress-bar bg-danger" style="width: {{ sin_match }}%">{{ sin_match }}%</div>
        </div>
    </div>
</div>

<!-- ACTIVIDAD RECIENTE -->
<div class="card p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Actividad reciente</h6>
    <a href="/bitacora/" class="small text-decoration-none">Ver todo</a>
  </div>
  <hr class="my-2">
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Usuario</th>
          <th>Acción</th>
          <th>Objeto</th>
          <th>Detalles</th>
        </tr>
      </thead>
      <tbody>
        {% for actividad in actividad_reciente %}
        <tr>
          <td class="fecha-completa">{{ actividad.fecha_hora }}</td>
          <td>{{ actividad.usuario }}</td>
          <td class="
            {% if actividad.accion == 'VALIDAR_PAGO' %}text-success
            {% elif actividad.accion == 'ANULAR_PAGO' %}text-danger
            {% else %}text-warning{% endif %}
          ">{{ actividad.accion }}</td>
          <td>{{ actividad.objeto }}</td>
          <td>{{ actividad.observacion|truncatechars:30|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-muted text-center">No hay actividad reciente</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.fecha-completa {
  font-family: 'Courier New', monospace;
  font-size: 0.85em;
  white-space: nowrap;
}
</style>

{% endblock %}