{% extends "base.html" %}
{% block content %}

<!-- KPIs -->
<div class="row g-3">
  <div class="col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Incidencias abiertas</div>
          <div class="fs-2 fw-bold">{{ incidencias_abiertas }}</div>
          <small class="text-danger"><i class="bi bi-arrow-up-right"></i> +2 vs ayer</small>
        </div>
        <i class="bi bi-exclamation-triangle-fill fs-1 text-warning"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Firmas pendientes</div>
          <div class="fs-2 fw-bold">{{ firmas_pendientes }}</div>
          <small class="text-muted"><i class="bi bi-dash"></i> igual que ayer</small>
        </div>
        <i class="bi bi-pen fs-1 text-info"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Último arqueo</div>
          <div class="fs-2 fw-bold text-success">OK</div>
          <small class="text-success"><i class="bi bi-check2"></i> conciliado</small>
        </div>
        <i class="bi bi-check2-circle fs-1 text-success"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Pagos hoy</div>
          <div class="fs-2 fw-bold">{{ total_pagos_hoy }}</div>
          <small class="text-success"><i class="bi bi-arrow-down-right"></i> -5% comisiones</small>
        </div>
        <i class="bi bi-cash-coin fs-1 text-primary"></i>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <!-- Alertas y pendientes -->
  <div class="col-lg-7">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Alertas recientes</h6>
        <a href="/conciliacion/" class="small text-decoration-none">Ir a Conciliación</a>
      </div>
      <hr class="my-2">
      <div class="list-group list-group-flush">
        {% for alerta in alertas_recientes %}
        <a class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <span class="badge 
              {% if alerta.tipo_incidencia == 'DIF_MONTO' %}text-bg-warning
              {% elif alerta.tipo_incidencia == 'SIN_MATCH' %}text-bg-danger
              {% else %}text-bg-info{% endif %} me-2">
              {{ alerta.tipo_incidencia }}
            </span>
            {{ alerta.descripcion }}
          </div>
          <small class="text-muted">{{ alerta.fecha_apertura|timesince }} ago</small>
        </a>
        {% empty %}
        <div class="list-group-item text-muted text-center">No hay alertas recientes</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card p-3 h-100">
      <h6 class="mb-1">Pendientes de firma</h6>
      <hr class="my-2">
      <ul class="list-unstyled small mb-3">
        {% for pendiente in pendientes_firma %}
        <li class="d-flex justify-content-between">
          <span>{{ pendiente.numero_referencia }} · {{ pendiente.get_tipo_incidencia_display }}</span>
          <span class="badge text-bg-secondary">{{ pendiente.get_estado_display }}</span>
        </li>
        {% empty %}
        <li class="text-muted text-center">No hay pendientes de firma</li>
        {% endfor %}
      </ul>
      <div class="d-grid gap-2">
        <a class="btn btn-primary" href="/conciliacion/"><i class="bi bi-diagram-2 me-1"></i> Conciliar & Arqueo</a>
        <a class="btn btn-outline-primary" href="/bitacora/"><i class="bi bi-journal-text me-1"></i> Ver Bitácora</a>
      </div>
    </div>
  </div>
</div>

<!-- Estado de conciliación de hoy -->
<div class="card p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Conciliación de hoy</h6>
    <small class="text-muted">Corte 12:00</small>
  </div>
  <hr class="my-2">
  <div class="row g-3">
    <div class="col-md-4">
      <div class="small text-muted mb-1">Match Sistema vs Externo</div>
      <div class="progress" role="progressbar" aria-label="match">
        <div class="progress-bar bg-success" style="width: 82%">82%</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="small text-muted mb-1">Diferencias (D2)</div>
      <div class="progress" role="progressbar" aria-label="diferencias">
        <div class="progress-bar bg-warning text-dark" style="width: 12%">12%</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="small text-muted mb-1">Sin match</div>
      <div class="progress" role="progressbar" aria-label="sin-match">
        <div class="progress-bar bg-danger" style="width: 6%">6%</div>
      </div>
    </div>
  </div>
</div>

<!-- Actividad reciente (mini bitácora) CORREGIDO -->
<div class="card p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Actividad reciente</h6>
    <a href="/bitacora/" class="small text-decoration-none">Ver todo</a>
  </div>
  <hr class="my-2">
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Usuario</th>
          <th>Acción</th>
          <th>Objeto</th>
          <th>Detalles</th>
        </tr>
      </thead>
      <tbody>
        {% for actividad in actividad_reciente %}
        <tr>
          <td class="fecha-completa">{{ actividad.fecha_hora }}</td>
          <td>{{ actividad.usuario }}</td>
          <td class="
            {% if actividad.accion == 'VALIDAR_PAGO' %}text-success
            {% elif actividad.accion == 'ANULAR_PAGO' %}text-danger
            {% else %}text-warning{% endif %}
          ">{{ actividad.accion }}</td>
          <td>{{ actividad.objeto }}</td>
          <td>{{ actividad.observacion|truncatechars:30|default:"-" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-muted text-center">No hay actividad reciente</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.fecha-completa {
  font-family: 'Courier New', monospace;
  font-size: 0.85em;
  white-space: nowrap;
}
</style>

{% endblock %}
